---
title: "LAI within Riparian Restorations, Final Project Data Sci Fall 2024"
output: pdf_document
date: "2024-11-22"
author: Holly Amer
---

```{r setup, include=FALSE}
 knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load in packages

library(ggplot2)
library(ggpubr)
library(tidyverse)
library(broom)

```


# Introduction
1)  Includes relevant background and references to scientific literature that foreshawdow the importance of each question;
 
 There have been more than 2,000 riparian restoration projects that have been planted over the last 30 years across Oregon. These projects are costly when it comes to money and time, so we want them to be well planned and reach the highest potential possible. They are beneficial to ecosystems because they positively impact water, wildlife, and humans that live near them. By researching riparian restorations across Oregon and looking at their growth over time, we can see which soil texture and water availability strata have the best effect on the plants within them. This will allow us to see which set of conditions will have the highest plant growth over time. 
 
  From my current research, there is data from riparian restorations within the western side of Oregon including the ecoregions of the Willamette Valley, Coast Range, and Klamath Mountains. The data collected ranges across different soil textures (fine/coarse), water stress (low/high), and age groups (0-5, 5-10, 10-15, 15-20, and 20+). It aims to study how LAI will differ through time, across Oregon, through soil textures and water availability. This research will tell us the most effective spatial areas in Oregon to conduct efforts in riparian restoration to draw down as much carbon as possible, and create essential refined spatial data to inform future climate mitigation decisions.
 
  There are many studies on Riparian Restorations, Western Oregon, and LAI as separate entities in many formats, but none that encompass all three areas. Detailed empirical data relating LAI and riparian restoration success has not been collected before in western Oregon. Soil texture and water stress are two variables that are known to affect plant growth and should be measured to assess their impacts on restoration projects within Oregon. To understand restoration trajectories, Leaf Area Index (LAI), a method that is widely used for measuring percent canopy cover, can be used to assess riparian planting success. Taking Digital Hemispherical Photos (DHP) allows researchers to have a permanent trace of data, which can be used for future comparisons and analyses (Fang et al., 2019, Chianucci and Cutini, 2012). LAI can be compared to variables such as soil texture and water stress, to assess how they impact plant growth over time. Restoration has been focused on as a primary goal in climate change mitigation for its positive impacts on biodiversity, wildlife habitats, and stream health. Carbon sequestration is a strong co-benefit of restoration that should be maximized (Dybala and Steger et al. 2018). 
  
  It is essential that ecologists measure the success of current riparian restoration projects, as we move into a future where restoration will continue to be a necessity for the health of our environment. So far, riparian restoration research has been spatially focused on North America, with South America with the next most studies (Dybala, Matzek, et al., 2018). There is also more focus on smaller temporal scales and fewer long-term studies that track ecosystem responses through climate change impacts (Li et al., 2022). Although more difficult, having studies over longer periods will help us to see how climate change affects these ecosystems, and which variables are the most affected. 
  


2)  a clear statement of 2-3 hypotheses. Using the OBA data, the hypotheses should address understanding a new dimension of bee conservation, ecology, or management. The hypotheses should be logical (i.e., make sense given published literature). 

 My questions include: What is the impact of soil texture, water stress, and age on Leaf Area Index (LAI) in Riparian Restoration projects in Western Oregon?

  My hypotheses are that as plantings become older, soil texture becomes more fine, and water stress is lower, LAI will increase. 


# Data
1) List of the three+ different data sets used, the type of data each represented, and general metadata (same as in the project workflow).
  I will primarily be using my own data. This includes Site info like water stress conditions, soil texture percentages, and age group, and the LAI values within each site/plot. 

2). The project should then read in and tidy the 2028-2023 data (including cleaning plant taxonomy if plant data is used, etc.) 

# Combining and Cleaning the data
```{r load in data}
# load in LAI data
LAI <- read.csv("RR_TNC_LAI_MASTER.csv", header = TRUE, colClasses = c("factor", "factor", "factor", "factor", "factor", "factor", "numeric", "factor", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric"))

#texture 2023
texture2023 <- read.csv("texture_2023.csv", header = TRUE)

#texture 2024
texture2024 <- read.csv("texture_2024.csv", header = TRUE)

# r data file with water stress contents
load("text_water.RData")


```

```{r cleaning the texture dataset}
# cleaning the texture dataset

# selecting relevant columns
texture2023 <- texture2023 %>% select(site, plot, sand, clay, silt)

# selecting relevant columns
texture2024 <- texture2024 %>% select(site, plot, sand, clay, silt)

# combining 2023 and 2024 datasets
texture <- rbind(texture2023, texture2024)

# group texture by site and take averages
texture <- texture %>%
  group_by(site) %>%
  summarize(
    avg_silt = mean(silt, na.rm = TRUE),
    avg_sand = mean(sand, na.rm = TRUE),
    avg_clay = mean(clay, na.rm = TRUE)
  )


# drop sites with poor data/no photos
texture <- texture %>%
  filter(!(site %in% c("DAMa", "DAMb", "FTE", "HC20a", "HF10b", "LC00a", "LC10b", "LF05e", "LF15d", "LF15e", "PRV", "WC")))

```

```{r cleaning the water stress dataset}
# cleaning the waterstress dataset

# group water stress by site and take averages
climatedeficit <- climatedeficit %>%
  group_by(site) %>%
  summarize(
    avg_deficit = mean(deficit, na.rm = TRUE))

# drop sites with poor data/no photos
climatedeficit <- climatedeficit %>%
  filter(!(site %in% c("HC00a", "HC00b", "HF00b", "HF15a", "LF00b", "HF00c", "DAMa", "DAMb", "FTE", "HC20a", "HF10b", "LC00a", "LC10b", "LF05e", "LF15d", "LF15e", "PRV", "WC", "LF20d")))

# check same number of sites in each dataset
nrow(climatedeficit) == nrow(texture)

```



# Data Wrangling and Summarizing
Manipulation and summarizing data in relevant ways using tables, scatter plots,  histograms, barplots, etc. Initial exploration of data.

```{r soil texture triangle and sites}
# soil texture traingle showing sites by texture type and age

# LAI and texture
texture_LAI <- merge(texture, LAI, by = "site")

master_dataset <- merge(texture_LAI, climatedeficit, by = "site")


library(ggtern)
library(ggplot2)
theme_set(theme_bw())
master_dataset %>%
  ggtern(aes(
    x = avg_sand,
    y = avg_clay,
    z = avg_silt,
    #color = years
    color = avg_deficit
  )) + 
  geom_point(size = 5) + 
  theme_showarrows() +
    labs(yarrow = "clay (%)",
       zarrow = "silt (%)",
       xarrow = "sand(%)",
       title = "Sites by Soil Texture and Water Deficit") +
  scale_colour_gradient(low = "#3288bd",
                        high = "#d53e4f", 
                        name = "Average Water Deficit") +
  theme_clockwise() +
  theme_hidetitles()


# https://saryace.github.io/flipbook_soiltexture_en/#1

```
```{r summary of water stress by age}
# grouping water stress
# deficit = PVT - EVT
# < 225 mm lower water stress, >225 mm higher water stress

master_dataset <- master_dataset %>%
  mutate(
    water_stress_group = case_when(
      avg_deficit <= 225 ~ "Low",
      avg_deficit > 225 ~ "High"
    )
  )

# summarizing
climate_summary <- master_dataset %>%
  group_by(water_stress_group) %>%
  summarize(num_sites = n_distinct(site))



# Bar graph for climate type
ggplot(climate_summary, aes(x = water_stress_group, y = num_sites, fill = water_stress_group)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Number of Sites by Climate Type",
    x = "Climate Type",
    y = "Number of Sites"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r scatterplot of lai values based on water stress and texture}
# average LAI by site 
master_dataset <- master_dataset %>%
  group_by(site) %>%
  mutate(LAI_4_ring_avg = mean(LAI_4_ring, na.rm = TRUE)) %>%
  ungroup()

# scatterplot of lai values based on water stress and texture

library(viridis)

ggplot(master_dataset, aes(
  x = years, 
  y = LAI_4_ring_avg, 
  color = avg_sand, 
  shape = water_stress_group
)) +
  geom_point(size = 3) + 
  scale_color_viridis() +
  labs(
    x = "Years", 
    y = "Average LAI", 
    color = "Average Sand (%)", 
    shape = "Water Stress Group",
    title = "Average LAI at Each Site by Sand %, Age, and Water Stress"
  ) +
  theme_minimal()
  




```


# Hypothesis test
Use of a statistical test (simulation of the null hypothesis, A/B testing or any other appropriate test) to test the stated hypotheses. 

Correct interpretation of the outcome of the test. 
```{r}

#correlation between texture and water stress
water_texture_correlation <- cor(master_dataset$avg_sand, master_dataset$avg_deficit, use = "complete.obs")
print(paste("Correlation coefficient:", water_texture_correlation))  

#center the data
master_dataset$texture_centered <- scale(master_dataset$avg_sand, center = TRUE, scale = FALSE)

master_dataset$water_centered <- scale(master_dataset$avg_deficit, center = TRUE, scale = FALSE)


# check for multicollinearity using the vif function in the car package
library(car)
modela <- lm(LAI_4_ring ~ texture_centered + water_centered + years + center_streambank, data = master_dataset)

vif(modela)

#acceptable values

# linear mixed effects model
library(lme4)
library(Matrix)

lmer_model <- lmer(LAI_4_ring ~ texture_centered * water_centered + years +
                     center_streambank +
                     (1 | site/plot), data = master_dataset)
summary(lmer_model)

model <- lm(LAI_4_ring_avg ~ texture_centered, data = master_dataset)
summary(model)

library(ggplot2)
ggplot(master_dataset, aes(x = LAI_4_ring_avg, y =texture_centered)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
  labs(x = "LAI", y = "% sand", title = "LAI vs sand")


library(lme4)
lai_scale <- master_dataset%>% mutate_if(is.numeric, scale)

mi <- lmer(LAI_4_ring ~ center_streambank * years + avg_sand + (1 | site/plot), data = lai_scale)

library(car)
vif(mi)


```




# Visualization
Final and publication-worthy visuals: They should address the hypotheses test, be clear, have correct labels, and include legends and units. 
```{r map of LAI points}
library(ggplot2)
library(sf)
library(viridis)
library(ggspatial)

# keep relevant data for mapping
LAI_mapping <- master_dataset %>% select(site, plot, avg_sand, years, latitude, longitude, water_stress_group)

# create a spatial object
LAI_sf <- st_as_sf(LAI_mapping, coords = c("longitude", "latitude"), crs = 4326)


# add ecoregions to map
ecoregions <- st_read("OR-ecoregions/Ecoregions_OregonConservationStrategy.shp")

# only relevant ecoregions
ecoregions_filtered <- ecoregions %>%
  filter(Ecoregion %in% c("Willamette Valley", "Klamath Mountains", "Coast Range"))

# make map
ggplot() +
  
  # ecoregions 
  geom_sf(data = ecoregions_filtered, aes(fill = Ecoregion), color = "black", alpha = 0.2) +
  
  # LAI points
  geom_sf(data = LAI_sf, aes(color = avg_sand, shape = water_stress_group), size = 3) +
  scale_color_viridis() + 
  labs(color = "Average Sand (%)", shape = "Water Stress Group") +
  theme_minimal() +
  theme(legend.position = "right") +
  scale_x_continuous(breaks = seq(-125, -120, by = 1)) +
  ggtitle("Map of LAI points by Ecoregion with Texture \n and Water Stress") +


# add a north arrow 
  annotation_north_arrow(location = "tl", which_north = "true", height = unit(.8, "cm"), width = unit(.7, "cm")) +
    
# add a scale
  annotation_scale(location = "bl", width_hint = 0.3, height = unit(.1, "cm"))





```


# Conclusion
Conclusion that clearly answers the original hypotheses.


# Overall
1) Use of version control on GitHub (commits equivalent to commiting ever hour); 
2) submission of a clear and complete rmarkdown and pdf; 
3) overall organized and clear final workflow, code, and explanations







